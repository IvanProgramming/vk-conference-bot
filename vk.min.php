<?php
class VKBot{const CHAT_PEER_ID=2000000000; protected $group_id; protected $token; protected $lang; protected $v; public $ph_dw_folder="images"; public function __construct(int$group_id,string$token,string$language=null,string$v=null){if($language===null){$language='ru';}if($v===null){$v='5.95';}$this->group_id=$group_id;$this->token=$token;$this->lang=$language;$this->v=(string)$v;} public function call(string$m,array$p=null){if(extension_loaded('curl')){if($p===null){$p=array();}if(!isset($p['lang']))$p['lang']=$this->lang;if(!isset($p['access_token']))$p['access_token']=$this->token;if(!isset($p['v']))$p['v']=$this->v;$a=$p['offToken']?"VKAndroidApp/5.11.1-2316":"VKBot/1.0";unset($p['offToken']);$ch=curl_init("https://api.vk.com/method/{$m}");curl_setopt_array($ch,array(CURLOPT_RETURNTRANSFER=>true,CURLOPT_USERAGENT=>$a,CURLOPT_POST=>true,CURLOPT_POSTFIELDS=>$p));$json=curl_exec($ch);curl_close($ch);return json_decode($json,true);}return false;} public function upload($url,$file){if(extension_loaded('curl')){$ch=curl_init($url);curl_setopt_array($ch,array(CURLOPT_POST=>true,CURLOPT_RETURNTRANSFER=>true,CURLOPT_POSTFIELDS=>array('file'=>new CURLfile($file))));$json=curl_exec($ch);curl_close($ch);return json_decode($json,true);}return false;} public function execute(string$code){return $this->call('execute',['code'=>$code]);}function send(int$peer_id,string$message,string$attachment=null,string$keyboard=null,int$reply_to=null,int$dont_parse_links=null){if($attachment===null){$attachment='';}if($keyboard===null){$keyboard='{"one_time": false, "buttons": []}';}if($reply_to===null){$reply_to=0;}if($dont_parse_links===null){$dont_parse_links=0;}$p=array();$p['peer_id']=$peer_id;$p['message']=$message;$p['attachment']=$attachment;$p['random_id']=0;if($reply_to>0)$p['reply_to']=$reply_to;if($peer_id>CHAT_PEER_ID)$p['keyboard']='{"one_time": false, "buttons": []}';elseif(!empty($keyboard))$p['keyboard']=$keyboard;else unset($p['keyboard']);$p['dont_parse_links']=$dont_parse_links;$r=$this->call('messages.send',$p);if(isset($response['error']))return $response['error'];return true;} public function uploadPhoto(string$filename){$server=$this->call('photos.getMessagesUploadServer')['response']['upload_url'];$upload=$this->upload($server,$filename);$save=$this->call('photos.saveMessagesPhoto',array('photo'=>$upload['photo'],'server'=>$upload['server'],'hash'=>$upload['hash']));return $save;} public function uploadDoc(string$filename,string$type=null){if($type===null){$type='doc';}$server=$this->call('docs.getMessagesUploadServer',array('type'=>$type))['response']['upload_url'];$upload=$this->upload($server,$filename);$save=$this->call('docs.save',array('file'=>$upload['file']));return $save;} public function isUserChatMember(int$peer_id,int$member_id){$api=$this->call('messages.getConversationMembers',array('peer_id'=>$peer_id));if(isset($api['error'])||empty($api['response']['items']))return false;foreach($api['response']['items'] as $p){if($p['member_id']!=$member_id)continue;return true;}return false;} public function isBotChatMember(int$peer_id){return (!isset(vkapi('messages.getConversationsById',array('peer_ids'=>$peer_id))['error']));} public function getTextBySex(int$user_id,string$male,string$female,int$sex=-1){if($sex==-1){$user=$this->call('users.get',array('user_ids'=>$user_id,'fields'=>'sex'));if(isset($user['response'])&&!empty($user['response'])){return ($user['sex']==1?$female:$male);}}else {return ($sex==1?$female:$male);}return $male;}}?>