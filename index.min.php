<?php
#VARIABLES Переменные для работы скрипта
#          Если не заполнить, то работать не будет
$group_id = /*ID сообщества*/; 
$confirmation_token = /*строка подтверждения*/;
$token = /*токен*/;
$stat_message = /*сообщение для того чтобы получить статистику*/;
$DB = array(
    'host' => /*хост базы данных*/,
    'user' => /*имя пользователя*/,
    'password' => /*пароль*/,
    'db_name' => /*имя базы данных*/
);
#VARIABLES
include "vk.php";if(!isset($_REQUEST)){return;}$vk=new VKBot($group_id,$token);$link=mysqli_connect($DB['host'],$DB['user'],$DB['password'],$DB['db_name']);if(!$link){echo "Error: Unable to connect to MySQL.".PHP_EOL;echo "Debugging errno: ".mysqli_connect_errno().PHP_EOL;echo "Debugging error: ".mysqli_connect_error().PHP_EOL;exit;}$data=json_decode(file_get_contents('php://input'));switch($data->type){case 'confirmation':echo $confirmation_token;break;case 'message_new':$user_id=$data->object->from_id;$message=$data->object->text;$peer_id=$data->object->peer_id;$chars_count=mb_strlen(str_replace(' ','',$message));$words_count=count(explode(' ',$message));if(strlen("{$peer_id}")>9){if($result_chat=$link->query('SELECT * FROM `chats` WHERE id_vk ='.$peer_id)){$res=$result_chat->fetch_array();if($res){if($message!=$stat_message){$link->query('UPDATE `chats` SET `all_msg`='.($res['all_msg']+1).',`all_words`='.($res['all_words']+$words_count).',`all_chars`='.($res['all_chars']+$chars_count).' WHERE `id`='.$res['id']);}}else {$link->query("INSERT INTO `chats`(`id_vk`, `all_msg`, `all_words`, `all_chars`, `debug`) VALUES ($peer_id, 1, $words_count, $chars_count, 1)");}}if($result_members=$link->query('SELECT * FROM `members` WHERE `id_vk` = '.$user_id.' AND `id_chat` = '.$peer_id)){$res_member=$result_members->fetch_array();if($res_member){if($message!=$stat_message){$link->query('UPDATE `members` SET `all_msg`='.($res_member['all_msg']+1).',`all_words`='.($res_member['all_words']+$words_count).',`all_chars`='.($res_member['all_chars']+$chars_count).' WHERE `id_vk` = '.$user_id.' AND `id_chat` = '.$peer_id);}}else {$link->query("INSERT INTO `members`(`id_vk`, `id_chat`, `all_msg`, `all_words`, `all_chars`) VALUES ($user_id, $peer_id, 1, $words_count, $chars_count)");}}}if($message==$stat_message){$top="";$ids=array();$msgs=array();$best=$link->query('SELECT * FROM `members` WHERE `id_chat` = '.$peer_id.' ORDER BY `all_msg` DESC LIMIT 10');$conference_stat=$link->query('SELECT * FROM `chats` WHERE `id_vk` = '.$peer_id);$stat=$conference_stat->fetch_array();while($best_row=$best->fetch_array()){array_push($ids,$best_row['id_vk']);array_push($msgs,$best_row['all_msg']);}$name_info=json_decode(file_get_contents("https://api.vk.com/method/users.get?user_ids=".implode(",",$ids)."&access_token={$token}&v=5.0"));for($i=0;$i<10;$i++){if(isset($msgs[$i])){$first_name=$name_info->response[$i]->first_name;$last_name=$name_info->response[$i]->last_name;$top=$top.($i+1).". ".$first_name." ".$last_name." - ".$msgs[$i].' ('.round(($msgs[$i]/$stat['all_msg'])*100).'%)'.PHP_EOL;}$vk->send($peer_id,"Общее количество сообщений с момента добавления бота в беседу - {$stat['all_msg']}".PHP_EOL."Общее количество слов {$stat['all_words']}".PHP_EOL."Общее количество символов {$stat['all_chars']}".PHP_EOL."Средняя длинна сообщения - ".(round($res['all_chars']/$stat['all_msg'])).PHP_EOL."Самые активные 10 участников (участниками считаются все те, кто писал после того как был добавлен бот)".PHP_EOL.PHP_EOL.$top);}echo ("ok");break;}?>